# Project Context

## Overview
This is a plain Ruby on Rails application.

## Tech Stack
- **Framework:** Ruby on Rails "~> 8.1"
- **Language:** Ruby
- **Database:** SQLite3
- **Frontend:**
  - **CSS:** Tailwind CSS (v4)
  - **JS:** Hotwire (Turbo & Stimulus)
  - **Bundler:** esbuild (JS), tailwindcss-cli (CSS)
- **Authentication:** Custom implementation (`Authentication` concern), `has_secure_password`
- **Icons:** Lucide Rails

## Development
- **Server**: `bin/dev` starts the Rails server and CSS/JS watchers. Never start the server instead assume it's running already.
- **Styles**: `app/assets/stylesheets/application.tailwind.css`.
- **Views**: Standard ERB templates.
- **Layouts**: Use `app/views/layouts/application.html.erb` for the main layout. Keep is simple, avoid adding extra layouts unless absolutely necessary. Ideally there should be only 4 layouts: `application`, `authentication`, `minimal`, `mailer`, `marketing`.
  - application - main app layout
  - authentication - used for login/signup pages
  - minimal - used for pages that require minimal UI chrome like single action pages
  - mailer - used for email templates
  - marketing - used for public marketing pages
- **Stimulus Controllers**: When adding new controllers, run `./bin/rails stimulus:manifest:update` to register them in `controllers/index.js`. Most of javascript logic should go into Stimulus controllers.
- **Javascript**: when adding a new javascript file that doesn't map to a Stimulus controller don't add it to the root directory of the `app/javascript` folder. Create a subfolder for it, e.g. `app/javascript/utils` or `app/javascript/lib` and add the new file there. Then import it in `app/javascript/application.js`. This is because all files in the root of `app/javascript` are treated as entrypoints by esbuild and will generate separate output files which is not desired for utility libraries.
- **Migrations**: When making changes to recent migrations, prefer rolling back and editing the existing migration file rather than creating a new migration. Use `./bin/rails db:rollback STEP=N` to rollback N migrations, edit the migration file, then run `./bin/rails db:migrate` again.
- **Scoped Record Access**: NEVER use `.find(id)` directly on a model (e.g., `Podcast.find(id)` or `PodcastEpisode.find(id)`). Always scope queries through the current user's context to ensure proper authorization. Use ActiveRecord queries that execute in the database, NOT methods like `flat_map` that load records into memory. Correct patterns: `Current.organization.podcasts.find(id)`, `PodcastEpisode.joins(:podcast).where(podcasts: { organization_id: Current.organization.id }).find(id)`. Direct model `.find()` is only acceptable for top-level records that don't require scoping.
- **Pagination**: The application uses the Pagy gem for pagination. Make sure to include `include Pagy::Method` in controllers where pagination is needed. If already included then ignore including it again.
- **Enums**: Use Rails 8 native enum support. Define enums in models using `enum status: { draft: 0, published: 1 }, prefix: :podcast` syntax. Avoid using gems like `enumerize`. Use a prefix for enum names to avoid conflicts, e.g., `status` becomes `podcast_status`. Use the enum methods generated by Rails, e.g., `podcast.podcast_published?`, `podcast.podcast_draft!`. Don't use the values directly unless absolutely necessary.

### Other Guidelines
- All business logic should reside in models. Any complex logic that usually is stored in service objects should be placed in models as class, instance methods or modules. Avoid creating service objects unless absolutely necessary.
  - Example: Instead of creating a `PodcastPublisher` service object, add a `publish!` instance method to the `Podcast` model. If the logic is complex, extract it into a class what gets the `Podcast` instance as argument and place that class in `app/models/podcast/` folder as `app/models/podcast/publisher.rb`.
  - Example: If the business logic operates on multiple podcasts place it in `app/models/podcasts/` folder as `app/models/podcasts/publisher.rb`.
- Use concerns for shared controller logic. Place them in `app/controllers/concerns`.
- Use partials for reusable view components. Place them in `app/views/application` or relevant subfolders.
- Scope all feature request to a path.
  - Example: For a Podcasts section features should be implemented under `/podcasts` path for what is related to a collection of podcasts. Use nested paths for related resources, e.g., `/podcasts/:podcast_id/episodes` for episodes related to a specific podcast. For podcast details use `/podcasts/:id`.
